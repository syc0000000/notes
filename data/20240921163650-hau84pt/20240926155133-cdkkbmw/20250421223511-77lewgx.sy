{"ID":"20250421223511-77lewgx","Spec":"1","Type":"NodeDocument","Properties":{"custom-custom-Haloweb-yaml":"---_esc_newline_created: '2025-04-21 22:35:11'_esc_newline_updated: '2025-04-22 00:04:05'_esc_newline_title: Redis事务 Lua 与 ACID特性解析_esc_newline_slug: redis-transactions-z9kfya_esc_newline_permalink: siyuan://blocks/20250421223511-77lewgx_esc_newline_desc: \u0026gt;-_esc_newline_  本文介绍了Redis事务的实现方式，包括 MULTI/EXEC 命令和 Lua 脚本，并分析了其 ACID 特性。文章指出，Redis_esc_newline_  事务不保证原子性和持久性，但可以保证一致性和隔离性。同时，讨论了 Redis 集群模式下事务的处理限制。_esc_newline_tags:_esc_newline_  - 面经_esc_newline_categories: []_esc_newline_---","id":"20250421223511-77lewgx","title":"Redis事务 Lua 与 ACID特性解析","type":"doc","updated":"20251129164909"},"Children":[{"ID":"20250421225033-fvwm4a7","Type":"NodeParagraph","Properties":{"id":"20250421225033-fvwm4a7","updated":"20250421230257"},"Children":[{"Type":"NodeText","Data":"要讨论Redis事务，首先要明确讨论的是什么，我们实质上在讨论“Redis有没有操作能实现ACID，或者部分实现ACID”，在这个定义的基础上，可以找到两个知识点："}]},{"ID":"20250421225208-foea31p","Type":"NodeList","ListData":{},"Properties":{"id":"20250421225208-foea31p","updated":"20250421225209"},"Children":[{"ID":"20250421225209-lvri0dk","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20250421225209-lvri0dk","updated":"20250421225209"},"Children":[{"ID":"20250421225209-ln0snjr","Type":"NodeParagraph","Properties":{"id":"20250421225209-ln0snjr","updated":"20250421225220"},"Children":[{"Type":"NodeText","Data":"MULTI/EXEC"}]}]},{"ID":"20250421225220-lpcbi4w","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20250421225220-lpcbi4w","updated":"20250421225220"},"Children":[{"ID":"20250421225220-uiddlb9","Type":"NodeParagraph","Properties":{"id":"20250421225220-uiddlb9","updated":"20250421225230"},"Children":[{"Type":"NodeText","Data":"Redis Lua"}]}]}]},{"ID":"20250421225233-4hyff5m","Type":"NodeParagraph","Properties":{"id":"20250421225233-4hyff5m","updated":"20250421231011"},"Children":[{"Type":"NodeText","Data":"先介绍一下这两个东西，介绍完之后，再讨论ACID。"}]},{"ID":"20250421225242-cc54ock","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20250421225242-cc54ock","updated":"20250422000605"},"Children":[{"Type":"NodeText","Data":"MULTI/EXEC"}]},{"ID":"20250421225257-d9gpadb","Type":"NodeParagraph","Properties":{"id":"20250421225257-d9gpadb","updated":"20250421225405"},"Children":[{"Type":"NodeText","Data":"这是一组命令的集合，我们一般说的"},{"Type":"NodeTextMark","TextMarkType":"em","TextMarkTextContent":"Redis事务"},{"Type":"NodeText","Data":"指的就是这个方式。事务支持一次执行多个命令，一个事务中所有命令都会被序列化。在事务执行过程，会按照顺序串行化执行队列中的命令，其他客户端提交的命令请求不会插入到事务执行命令序列中。"}]},{"ID":"20250421225453-77k2vp2","Type":"NodeParagraph","Properties":{"id":"20250421225453-77k2vp2","updated":"20250421225500"},"Children":[{"Type":"NodeText","Data":"具体使用方法是："}]},{"ID":"20250421225510-us7qjo6","Type":"NodeParagraph","Properties":{"id":"20250421225510-us7qjo6","updated":"20250421225725"},"Children":[{"Type":"NodeText","Data":"先输入"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"MULTI"},{"Type":"NodeText","Data":"​，开启事务，然后输入若干命令，redis会将后续的命令逐个放入队列中，然后使用"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"EXEC"},{"Type":"NodeText","Data":"​命令来原子化执行这个命令系列。"}]},{"ID":"20250421233549-a7zqwyq","Type":"NodeParagraph","Properties":{"id":"20250421233549-a7zqwyq","updated":"20250421233708"},"Children":[{"Type":"NodeText","Data":"如果执行过程中有运行时错误，会让这一条命令失败，剩下的会继续执行，不会回滚。如果有语法错误，会在执行前报错，全都不会执行。"}]},{"ID":"20250421225559-qhmf46i","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20250421225559-qhmf46i","style":"line-height: 22px;","updated":"20250421225615"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHl0aG9u"},{"Type":"NodeCodeBlockCode","Data":"127.0.0.1:6379\u003e set k1 v1\nOK\n127.0.0.1:6379\u003e set k2 v2\nOK\n127.0.0.1:6379\u003e MULTI\nOK\n127.0.0.1:6379\u003e set k1 11\nQUEUED\n127.0.0.1:6379\u003e set k2 22\nQUEUED\n127.0.0.1:6379\u003e EXEC\nOK\nOK\n127.0.0.1:6379\u003e get k1\n\"11\"\n127.0.0.1:6379\u003e get k2\n\"22\"\n127.0.0.1:6379\u003e \n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20250421225605-eay2olv","Type":"NodeParagraph","Properties":{"id":"20250421225605-eay2olv","updated":"20250421225744"},"Children":[{"Type":"NodeText","Data":"或者不使用"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"EXEC"},{"Type":"NodeText","Data":"​，使用"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"DISCARD"},{"Type":"NodeText","Data":"​来取消事务，那么这些命令都不会执行。"}]},{"ID":"20250421225937-z6qmf42","Type":"NodeParagraph","Properties":{"id":"20250421225937-z6qmf42","updated":"20250422000550"},"Children":[{"Type":"NodeText","Data":"进一步的，Redis提供了"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"WATCH"},{"Type":"NodeText","Data":"​和"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"UNWATCH"},{"Type":"NodeText","Data":"​两个命令，它们主要用于确保操作的隔离性。"}]},{"ID":"20250421225937-9epgcsn","Type":"NodeParagraph","Properties":{"id":"20250421225937-9epgcsn","updated":"20250421230028"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"WATCH"},{"Type":"NodeText","Data":"​命令用于监控一个或多个键，在事务"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"EXEC"},{"Type":"NodeText","Data":"​时，如果监控的键值被其他客户端修改，那么事务将会不会执行，从而保证事务的执行不会受到其他操作的影响。"}]},{"ID":"20250421225937-iabtnj4","Type":"NodeParagraph","Properties":{"id":"20250421225937-iabtnj4","updated":"20250421225937"},"Children":[{"Type":"NodeText","Data":"在事务执行前调用"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"UNWATCH"},{"Type":"NodeText","Data":"​命令，可以取消之前通过"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"WATCH"},{"Type":"NodeText","Data":"​命令设置的监控。"}]},{"ID":"20250421225937-vwyea7m","Type":"NodeParagraph","Properties":{"id":"20250421225937-vwyea7m","updated":"20250421225937"},"Children":[{"Type":"NodeText","Data":"在Redis中，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"WATCH"},{"Type":"NodeText","Data":"​、"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"MULTI"},{"Type":"NodeText","Data":"​和"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"EXEC"},{"Type":"NodeText","Data":"​三个命令通常一起使用，形成一个完整的事务操作流程："}]},{"ID":"20250421225937-ov1b4x4","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20250421225937-ov1b4x4","updated":"20250421225937"},"Children":[{"ID":"20250421225937-hkb8sr7","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20250421225937-hkb8sr7","updated":"20250421225937"},"Children":[{"ID":"20250421225937-rl68quj","Type":"NodeParagraph","Properties":{"id":"20250421225937-rl68quj","updated":"20250421225937"},"Children":[{"Type":"NodeText","Data":"使用"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"WATCH"},{"Type":"NodeText","Data":"​命令监控一个或多个键。"}]}]},{"ID":"20250421225937-rwav9yi","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20250421225937-rwav9yi","updated":"20250421225937"},"Children":[{"ID":"20250421225937-pvvq0v8","Type":"NodeParagraph","Properties":{"id":"20250421225937-pvvq0v8","updated":"20250421225937"},"Children":[{"Type":"NodeText","Data":"使用"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"MULTI"},{"Type":"NodeText","Data":"​命令开始一个事务。"}]}]},{"ID":"20250421225937-g0pr9c5","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20250421225937-g0pr9c5","updated":"20250421225937"},"Children":[{"ID":"20250421225937-23csvob","Type":"NodeParagraph","Properties":{"id":"20250421225937-23csvob","updated":"20250421225937"},"Children":[{"Type":"NodeText","Data":"在事务中执行一系列命令。"}]}]},{"ID":"20250421225937-0rex2r3","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NC4=","Num":4},"Properties":{"id":"20250421225937-0rex2r3","updated":"20250421225937"},"Children":[{"ID":"20250421225937-2dx5yio","Type":"NodeParagraph","Properties":{"id":"20250421225937-2dx5yio","updated":"20250421225937"},"Children":[{"Type":"NodeText","Data":"使用"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"EXEC"},{"Type":"NodeText","Data":"​命令提交事务。"}]}]}]},{"ID":"20250421225937-go32te9","Type":"NodeParagraph","Properties":{"id":"20250421225937-go32te9","updated":"20250422000605"},"Children":[{"Type":"NodeText","Data":"如果监控的键值被修改，事务将不会执行，并且所有命令都会被丢弃。"}]},{"ID":"20250421230141-zu9k9yy","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20250421230141-zu9k9yy","updated":"20250421231055"},"Children":[{"Type":"NodeText","Data":"Redis Lua"}]},{"ID":"20250421230156-wq8i6nf","Type":"NodeParagraph","Properties":{"id":"20250421230156-wq8i6nf","updated":"20250421230734"},"Children":[{"Type":"NodeText","Data":"Redis支持使用Lua脚本来编写更复杂的“事务”，通过"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"EVAL"},{"Type":"NodeText","Data":"​命令，可以执行一段Lua脚本，在脚本内通过"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"redis.call()"},{"Type":"NodeText","Data":"​或者"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"redis.pcall()"},{"Type":"NodeText","Data":"​，可以执行对应的操作。"}]},{"ID":"20250421230536-d6l282v","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20250421230536-d6l282v","style":"line-height: 22px;","updated":"20250421230806"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cGxhaW50ZXh0"},{"Type":"NodeCodeBlockCode","Data":"EVAL script numkeys [key [key ...]] [arg [arg ...]]\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20250421225925-foy64vw","Type":"NodeParagraph","Properties":{"id":"20250421225925-foy64vw","updated":"20250421231055"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"call()"},{"Type":"NodeText","Data":"​在中间指令出问题后，会中断执行，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"pcall()"},{"Type":"NodeText","Data":"​不会。"}]},{"ID":"20250421231055-gyh9qr2","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20250421231055-gyh9qr2","updated":"20251129164909"},"Children":[{"Type":"NodeText","Data":"ACID"}]},{"ID":"20250421232115-gbbhtw9","Type":"NodeParagraph","Properties":{"id":"20250421232115-gbbhtw9","updated":"20250421232159"},"Children":[{"Type":"NodeText","Data":"此时，我们可以来分析这两种方案的ACID特性。"}]},{"ID":"20250421232234-zvq44em","Type":"NodeList","ListData":{},"Properties":{"id":"20250421232234-zvq44em","updated":"20250421232246"},"Children":[{"ID":"20250421232246-shzlfmd","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20250421232246-shzlfmd","updated":"20250421232246"},"Children":[{"ID":"20250421232246-reytrtn","Type":"NodeParagraph","Properties":{"id":"20250421232246-reytrtn","updated":"20250421234346"},"Children":[{"Type":"NodeText","Data":"Atom 原子性 "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"不保证"},{"Type":"NodeText","Data":"\n这里涉及到原子性定义的问题，我认为原子性是指“要么全部成功，要么全部不成功”，在事务发生错误时，并不会回滚，所以不保证原子性。"}]}]},{"ID":"20250421232447-rwtw3ws","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20250421232447-rwtw3ws","updated":"20250421232447"},"Children":[{"ID":"20250421232447-xsz0loj","Type":"NodeParagraph","Properties":{"id":"20250421232447-xsz0loj","updated":"20250421234124"},"Children":[{"Type":"NodeText","Data":"Consistency 一致性 "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"能保证"},{"Type":"NodeText","Data":"\n一串Redis命令，不管有没有成功，Redis首先不会让命令本身破坏自己的结构，我们认为这种情况下是保证一致性的。如果执行过程中实例发生故障，恢复数据时RDB不会记录执行到一半的事务，AOF也可以通过"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"redis-check-aof"},{"Type":"NodeText","Data":"​来处理一下，也可以保证不记录执行到一半的事务。"}]}]},{"ID":"20250421234328-1fouj7l","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20250421234328-1fouj7l","updated":"20250421234328"},"Children":[{"ID":"20250421234328-3mdboj6","Type":"NodeParagraph","Properties":{"id":"20250421234328-3mdboj6","updated":"20250421234513"},"Children":[{"Type":"NodeText","Data":"Isolation 隔离性 "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"能保证"},{"Type":"NodeText","Data":"\n因为Redis是单线程程序，执行Lua脚本时，会逐条解释执行，在执行过程中不会出现并发问题，能保证原子性，Redis事务也一样，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"EXEC"},{"Type":"NodeText","Data":"​指令一旦发出，过程中不存在并发问题。\n再加上WATCH，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"WATCH"},{"Type":"NodeText","Data":"​检查发生于"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"EXEC"},{"Type":"NodeText","Data":"​之前，是因为在shell编写的过程中并不是阻塞的，相当于一个乐观锁，保证了从编写阶段开始的隔离性"}]}]},{"ID":"20250421234517-2vsuhfg","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20250421234517-2vsuhfg","updated":"20250421234517"},"Children":[{"ID":"20250421234517-uapin8e","Type":"NodeParagraph","Properties":{"id":"20250421234517-uapin8e","updated":"20250421234545"},"Children":[{"Type":"NodeText","Data":"Durability 持久性 "},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"不保证"},{"Type":"NodeText","Data":"\nRedis当然不保证持久性"}]}]}]},{"ID":"20250421234753-shd8uiq","Type":"NodeThematicBreak","Properties":{"id":"20250421234753-shd8uiq","updated":"20250421234753"}},{"ID":"20250421232302-z3vun38","Type":"NodeParagraph","Properties":{"id":"20250421232302-z3vun38","updated":"20250421234807"},"Children":[{"Type":"NodeText","Data":"这里还有一种特殊情况——Redis集群。"}]},{"ID":"20250421234807-blszfx7","Type":"NodeParagraph","Properties":{"id":"20250421234807-blszfx7","updated":"20250421235835"},"Children":[{"Type":"NodeText","Data":"当Redis处于集群的"},{"Type":"NodeTextMark","TextMarkType":"em","TextMarkTextContent":"集群模式"},{"Type":"NodeText","Data":"时，首先直接不能支持原生事务，如果使用Lua脚本，连SLOT都不能跨需要用Hash Tag这类的方案来处理。"}]},{"ID":"20251129164909-kh4cdew","Type":"NodeParagraph","Properties":{"id":"20251129164909-kh4cdew","updated":"20251129164909"}}]}