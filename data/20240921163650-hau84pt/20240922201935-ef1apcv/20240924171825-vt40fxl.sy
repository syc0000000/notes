{"ID":"20240924171825-vt40fxl","Spec":"1","Type":"NodeDocument","Properties":{"custom-common-Halo-yaml":"---_esc_newline_created: '2024-09-24 17:18:25'_esc_newline_updated: '2024-09-24 18:28:22'_esc_newline_title: 邮箱验证码_esc_newline_slug: email-verification-code-2bsfwy_esc_newline_permalink: siyuan://blocks/20240924171825-vt40fxl_esc_newline_tags:_esc_newline_  - 招新平台设计_esc_newline_categories: []_esc_newline_---","id":"20240924171825-vt40fxl","tags":"招新平台设计","title":"邮箱验证码","type":"doc","updated":"20240924182801"},"Children":[{"ID":"20240924171825-vcnszc4","Type":"NodeParagraph","Properties":{"id":"20240924171825-vcnszc4","updated":"20240924172633"},"Children":[{"Type":"NodeText","Data":"在注册账号、重置密码、验证身份等场景下，需要利用验证码验证用户身份，在确认用户操作后再执行下一步操作。"}]},{"ID":"20240924172633-q73d4uq","Type":"NodeParagraph","Properties":{"id":"20240924172633-q73d4uq","updated":"20240924172653"},"Children":[{"Type":"NodeText","Data":"拆解为关键节点："}]},{"ID":"20240924172653-mj3vvtp","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20240924172653-mj3vvtp","updated":"20240924172654"},"Children":[{"ID":"20240924172654-6evpcfx","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20240924172654-6evpcfx","updated":"20240924172654"},"Children":[{"ID":"20240924172654-7udnpyz","Type":"NodeParagraph","Properties":{"id":"20240924172654-7udnpyz","updated":"20240924172710"},"Children":[{"Type":"NodeText","Data":"生成验证码"}]}]},{"ID":"20240924172726-2qa68f7","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20240924172726-2qa68f7","updated":"20240924172726"},"Children":[{"ID":"20240924172726-goboqhl","Type":"NodeParagraph","Properties":{"id":"20240924172726-goboqhl","updated":"20240924172847"},"Children":[{"Type":"NodeText","Data":"设计逻辑验证验证码有效期"}]}]},{"ID":"20240924172848-e6be8m5","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20240924172848-e6be8m5","updated":"20240924172848"},"Children":[{"ID":"20240924172848-ee1q96p","Type":"NodeParagraph","Properties":{"id":"20240924172848-ee1q96p","updated":"20240924172917"},"Children":[{"Type":"NodeText","Data":"利用SMTP服务发送邮件"}]}]},{"ID":"20240924172938-votmvbz","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NC4=","Num":4},"Properties":{"id":"20240924172938-votmvbz","updated":"20240924172938"},"Children":[{"ID":"20240924172938-ltcmg8c","Type":"NodeParagraph","Properties":{"id":"20240924172938-ltcmg8c","updated":"20240924172944"},"Children":[{"Type":"NodeText","Data":"验证验证码有效性"}]}]}]},{"ID":"20240924172945-3awk1mi","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240924172945-3awk1mi","updated":"20240924181243"},"Children":[{"Type":"NodeText","Data":"生成验证码"}]},{"ID":"20240924172951-3cvqaej","Type":"NodeParagraph","Properties":{"id":"20240924172951-3cvqaej","updated":"20240924173014"},"Children":[{"Type":"NodeText","Data":"简单的六位随机数"}]},{"ID":"20240924173041-qktxri7","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240924173041-qktxri7","updated":"20240924173046"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ=="},{"Type":"NodeCodeBlockCode","Data":"private String genCode(){\n        //生成随机数6位\n        Random random = new Random();\n        StringBuilder buffer = new StringBuilder();\n        for (int i = 0; i \u003c 6; i++) {\n            int number = random.nextInt(10);\n            buffer.append(number);\n        }\n        return String.valueOf(buffer);\n    }\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240924181243-0vfus3t","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240924181243-0vfus3t","updated":"20240924181658"},"Children":[{"Type":"NodeText","Data":"存储验证码"}]},{"ID":"20240924181254-dd3qq5g","Type":"NodeParagraph","Properties":{"id":"20240924181254-dd3qq5g","updated":"20240924181658"},"Children":[{"Type":"NodeText","Data":"向redis中保存邮箱、发送时间和验证码，便于后续使用的时候验证。"}]},{"ID":"20240924181322-qf814de","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240924181322-qf814de","updated":"20240924181536"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ=="},{"Type":"NodeCodeBlockCode","Data":"@PostMapping(\"/registerCode\")\n    public Response\u003cVoid\u003e sendCode(@RequestBody @Valid RegisterCodeDTO registerDTO) throws MessagingException {\n\t\t//省略GoogleChapta相关代码\n        Users usersParams = new Users();\n        usersParams.setEmail(registerDTO.getEmail());\n\t\t//验证用户是否重复\n        Users usersRet = usersService.queryByUsers(usersParams);\n        if (usersRet != null){\n            return new Response.Builder\u003cVoid\u003e()\n                    .code(ResponseCode.USERS_EMAIL_ALREADY_REGISTER)\n                    .build();\n        }\n\t\t//生成验证码\n        String code = genCode();\n        long now = new Date().getTime();\n        String token = CryptoUtil.encodeMD5Hex(registerDTO.getEmail()+now);\n\t\t//发送邮件\n        sendCode(registerDTO.getEmail(),code);\n\n\t\t//把邮箱-时间-验证码存入redis\n        stringRedisTemplate.opsForValue().set(RedisServicePreFix.USER_SERVICE +\n                RedisEntityPreFix.REGISTER_CODE + token,code,300,TimeUnit.SECONDS);\n    \n\t\treturn new Response.Builder\u003cVoid\u003e()\n                .code(ResponseCode.COMMON_SUCCESS)\n                .message(\"发送成功, 请登录邮箱及时查看\")\n                .build();\n    }\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240924181413-g156nnb","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240924181413-g156nnb","updated":"20240924182352"},"Children":[{"Type":"NodeText","Data":"发送验证码"}]},{"ID":"20240924181742-v28zaju","Type":"NodeParagraph","Properties":{"id":"20240924181742-v28zaju","updated":"20240924181744"},"Children":[{"Type":"NodeText","Data":"代码如下"}]},{"ID":"20240924181739-sjwqz9i","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240924181739-sjwqz9i","updated":"20240924181754"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ=="},{"Type":"NodeCodeBlockCode","Data":"private void sendCode(String email,String code) throws MessagingException {\n        MimeMessage mimeMessage = mailSender.createMimeMessage();\n        MimeMessageHelper helper = new MimeMessageHelper(mimeMessage,true);\n        helper.setFrom(\"xx工作室\u003c\"+mailUsername+\"\u003e\");\n        helper.setTo(email);\n        helper.setSubject(\"验证码\");\n        Map\u003cString,Object\u003e map = new HashMap\u003c\u003e();\n        map.put(\"email\",email);\n        map.put(\"code\",code);\n        helper.setText(emailUtil.builderContent(\"code.html\",map),true);\n        mailSender.send(mimeMessage);\n    }\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240924181745-543a2em","Type":"NodeParagraph","Properties":{"id":"20240924181745-543a2em","updated":"20240924182249"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"MimeMessageHelper"},{"Type":"NodeText","Data":"​类是SpringMail组件提供的，可以用模板html填充的方式组件邮件内容，然后直接发送即可。对接邮件服务器相关配置在Spring配置文件中，这种敏感信息建议从环境变量读取，以防一不小心传给别人然后忘了或者不小心传到Github了。"}]},{"ID":"20240924182334-3248gs7","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240924182334-3248gs7","updated":"20240924182341"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"cHJvcGVydGllcw=="},{"Type":"NodeCodeBlockCode","Data":"#邮件测试\nspring.mail.username=${MAIL_USER:}\nspring.mail.password=${MAIL_PASSWORD:}\nspring.mail.properties.mail.smtp.auth=true\nspring.mail.protocol=smtps\nspring.mail.properties.mail.ssl.enable=true\n#spring.mail.properties.mail.smtp.socketFactory.class=javax.net.ssl.SSLSocketFactory\n#spring.mail.properties.mail.smtp.starttls.enable=true\nspring.mail.default-encoding=UTF-8\nspring.mail.port=465\nspring.mail.host=${MAIL_HOST:}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240924182352-00eto9d","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240924182352-00eto9d","updated":"20240924182801"},"Children":[{"Type":"NodeText","Data":"验证验证码有效性"}]},{"ID":"20240924182544-aukdn50","Type":"NodeParagraph","Properties":{"id":"20240924182544-aukdn50","updated":"20240924182801"},"Children":[{"Type":"NodeText","Data":"这里直接写一段Lua，去Redis里面读出结果对比一下就行。"}]},{"ID":"20240924182528-0v8pgmx","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240924182528-0v8pgmx","updated":"20240924182535"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ=="},{"Type":"NodeCodeBlockCode","Data":"private Long checkCode(String key, String code) {\n        String codeLua = \"local code=redis.call('get',KEYS[1]) \"+\n                \"if code==false then \"+\n                \"return 0 \"+\n                \"end \"+\n                \"if code~=ARGV[1] then \"+\n                \"return 0 \"+\n                \"end \"+\n                \"redis.call('del',KEYS[1]) \"+\n                \"return 1 \";\n        DefaultRedisScript\u003cLong\u003e codeScript = new DefaultRedisScript\u003c\u003e(codeLua, Long.class);\n        return stringRedisTemplate.execute(codeScript,\n                Collections.singletonList(key),\n                code\n        );\n    }\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240924182536-u5rriny","Type":"NodeParagraph","Properties":{"id":"20240924182536-u5rriny","updated":"20240924182536"}}]}