{"ID":"20240922202007-jfh49nb","Spec":"1","Type":"NodeDocument","Properties":{"custom-common-Halo-yaml":"---_esc_newline_created: '2024-09-22 20:20:07'_esc_newline_updated: '2024-09-22 22:34:15'_esc_newline_title: RBAC权限管理_esc_newline_slug: rbac-permission-management-z15uidp_esc_newline_permalink: siyuan://blocks/20240922202007-jfh49nb_esc_newline_tags:_esc_newline_  - 招新平台设计_esc_newline_  - Java_esc_newline_categories: []_esc_newline_---","id":"20240922202007-jfh49nb","tags":"招新平台设计,Java","title":"RBAC权限管理","type":"doc","updated":"20240922223406"},"Children":[{"ID":"20240922202147-7rsnxy3","Type":"NodeParagraph","Properties":{"id":"20240922202147-7rsnxy3","updated":"20240922202536"},"Children":[{"Type":"NodeText","Data":"Role-Based Access Control：基于角色的权限控制。通过角色关联用户，角色关联权限的方式间接赋予用户权限。在后端开发场景下，权限即表示对某path的可访问性or能访问到什么地步。具体到实现上，一是验证这个请求能否访问这个path，二是验证这个请求的参数是否符合他的权限。"}]},{"ID":"20240922202540-y52o6rk","Type":"NodeParagraph","Properties":{"id":"20240922202540-y52o6rk","updated":"20240922202550"},"Children":[{"Type":"NodeText","Data":"在招新平台中，具体的实现思路是："}]},{"ID":"20240922202743-yyj2gwa","Type":"NodeParagraph","Properties":{"id":"20240922202743-yyj2gwa","updated":"20240922202928"},"Children":[{"Type":"NodeText","Data":"包含三个基本单位：路径、用户、权限组"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"（角色）"},{"Type":"NodeText","Data":"。用户属于某个权限组，某个权限组拥有某些路径的访问权限。"}]},{"ID":"20240922202553-0fa1nd8","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20240922202553-0fa1nd8","updated":"20240922203154"},"Children":[{"ID":"20240922202656-euztrd2","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20240922202656-euztrd2","updated":"20240922203153"},"Children":[{"ID":"20240922202656-4i1crqk","Type":"NodeParagraph","Properties":{"id":"20240922202656-4i1crqk","updated":"20240922203153"},"Children":[{"Type":"NodeText","Data":"初始化：获取整个项目的所有路径以方便后续分配权限。"}]}]},{"ID":"20240922202720-0ktxqho","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20240922202720-0ktxqho","updated":"20240922203154"},"Children":[{"ID":"20240922202720-x5wa6uo","Type":"NodeParagraph","Properties":{"id":"20240922202720-x5wa6uo","updated":"20240922203154"},"Children":[{"Type":"NodeText","Data":"配置权限：在配置页面，配置每个用户组能访问的路径，同时配置某个用户属于哪个权限组。"}]}]},{"ID":"20240922202936-1hrhwp7","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20240922202936-1hrhwp7","updated":"20240922203150"},"Children":[{"ID":"20240922202936-ner2xty","Type":"NodeParagraph","Properties":{"id":"20240922202936-ner2xty","updated":"20240922203150"},"Children":[{"Type":"NodeText","Data":"拦截请求：向springboot中添加interceptor，拦截请求。"}]}]},{"ID":"20240922203029-k39irym","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NC4=","Num":4},"Properties":{"id":"20240922203029-k39irym","updated":"20240922203150"},"Children":[{"ID":"20240922203029-f8tnnml","Type":"NodeParagraph","Properties":{"id":"20240922203029-f8tnnml","updated":"20240922203150"},"Children":[{"Type":"NodeText","Data":"检验权限：符合条件正常放行，不符合条件返回403 forbidden。"}]}]}]},{"ID":"20240922202007-klynw9i","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240922202007-klynw9i","updated":"20240922220805"},"Children":[{"Type":"NodeText","Data":"初始化"}]},{"ID":"20240922202135-7dkl95u","Type":"NodeParagraph","Properties":{"id":"20240922202135-7dkl95u","updated":"20240922220805"},"Children":[{"Type":"NodeText","Data":"分为路径初始化和权限初始化两个步骤。路径初始化是指提取整个项目所有路径，并保存到MySQL数据库。"}]},{"ID":"20240922214828-gxs0q5g","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240922214828-gxs0q5g","updated":"20240922214832"},"Children":[{"Type":"NodeText","Data":"路径初始化"}]},{"ID":"20240922203213-h0edpzt","Type":"NodeParagraph","Properties":{"id":"20240922203213-h0edpzt","updated":"20240922213715"},"Children":[{"Type":"NodeText","Data":"Springboot会把所有URL和Method（具体而言是RequestMapping注解的信息封装的RequestMappingInfo类）与JAVA类的对应关系保存到RequestMappingHandlerMapping对象中，通过这对象获取所有接口并保存到数据库中。"}]},{"ID":"20240922213716-871az4f","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240922213716-871az4f","updated":"20240922214208"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ=="},{"Type":"NodeCodeBlockCode","Data":"@PostConstruct\n    private void initPaths(){\n        log.info(\"path初始化开始\");\n        initPermissionGroups();\n        // 生成版本号\n        Long versionId = SnowflakeUtil.getId();\n        // 新增预先设置的path\n        initPrePaths(versionId);\n        // 将管理员加入dev组中\n        initAdmin();\n        // 获取所有path\n        Map\u003cRequestMappingInfo, HandlerMethod\u003e requestMappingInfoHandlerMethodMap = requestMappingHandlerMapping.getHandlerMethods();\n        for (Map.Entry\u003cRequestMappingInfo, HandlerMethod\u003e m : requestMappingInfoHandlerMethodMap.entrySet()) {\n            RequestMappingInfo info = m.getKey();\n            HandlerMethod method = m.getValue();\n            RequestMethodsRequestCondition methodsCondition = info.getMethodsCondition();\n            if (methodsCondition.getMethods().isEmpty()){\n                continue;\n            }\n\n            Paths entity = getPathByRequestMappingInfo(versionId, m);\n            entity = pathsService.insertOrUpdate(entity);\n\n            // 判断是否有默认组\n            // 省略默认组相关逻辑，这里提供了一个注解，可以写在控制器类上，可以直接注明这个类默认是什么权限组的，方便配置。\n        }\n        // 查询所有旧path\n        List\u003cPaths\u003e oldPaths = pathsService.queryAllOldPath(versionId);\n        for (Paths oldPath:\n                oldPaths) {\n            pathsService.deleteByIdAndHandleGroupAndBlackList(oldPath.getId());\n        }\n        log.info(\"path初始化结束\");\n    }\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240922202551-aaxgm39","Type":"NodeHeading","HeadingLevel":3,"Properties":{"id":"20240922202551-aaxgm39","updated":"20240922221315"},"Children":[{"Type":"NodeText","Data":"权限初始化"}]},{"ID":"20240922214846-ecuv2bo","Type":"NodeParagraph","Properties":{"id":"20240922214846-ecuv2bo","updated":"20240922220634"},"Children":[{"Type":"NodeText","Data":"这里实际上是一个优化措施，只初始化免登录与基础权限组（实质上是把相关内容从数据库搬到内存中），保存在PermissionMappingInfo类的变量里面，后续在检查这两个权限时，直接拿出这个Bean，获取变量然后检验就可以，速度可以非常快（因为不用访问数据库）。"}]},{"ID":"20240922220827-2qvfar3","Type":"NodeParagraph","Properties":{"id":"20240922220827-2qvfar3","updated":"20240922220933"},"Children":[{"Type":"NodeText","Data":"这里的具体逻辑写在："}]},{"ID":"20240922220921-50x42qx","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240922220921-50x42qx","updated":"20240922221315"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ=="},{"Type":"NodeCodeBlockCode","Data":"//对应Config类\n@PostConstruct//在SpringBean全部构建完成后要做的操作（系统启动时的初始化操作）\n    public void init() throws InterruptedException {\n        log.info(\"权限初始化开始\");\n        permissionMappingInfo.init(requestMappingHandlerMapping);\n        log.info(\"权限初始化完成\");\n    }\n\n//PermissionMappingInfo类\npublic void init(RequestMappingHandlerMapping requestMappingHandlerMapping) throws InterruptedException {\n        this.requestMappingHandlerMapping = requestMappingHandlerMapping;\n        methodsPermissionGroupsNoNeedLogin = new ConcurrentHashMap\u003c\u003e();\n        methodsPermissionGroupsOther = new ConcurrentHashMap\u003c\u003e();\n        methodsPermissionGroupsIsBase = new ConcurrentHashMap\u003c\u003e();\n        updateMappingInfoExecutor = new ThreadPoolExecutor(8,\n                8,\n                100,\n                TimeUnit.MILLISECONDS,\n                new ArrayBlockingQueue\u003c\u003e(100),\n                new ThreadPoolExecutor.CallerRunsPolicy()\n        );\n        preInit();//函数内容是调用setAllMappingPermissionGroupsInfo()\n        updateMappingInfoExecutor.execute(this::task);\n    }\n\n\t//定时任务，每十秒刷新这两个组的内容\n    private void task() {\n        try {\n            while (true) {\n                setAllMappingPermissionGroupsInfo();//作用是读取数据库，把内容读取到内存中\n                clearOldData();\n                Thread.sleep(10000);\n            }\n        }catch (Exception e) {\n            log.error(\"ERROR: \", e);\n        }\n    }\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240922220922-q0ogniy","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240922220922-q0ogniy","updated":"20240922222526"},"Children":[{"Type":"NodeText","Data":"配置权限"}]},{"ID":"20240922221348-q4ue5ml","Type":"NodeParagraph","Properties":{"id":"20240922221348-q4ue5ml","updated":"20240922222507"},"Children":[{"Type":"NodeText","Data":"这个比较简单，主要是写个接口更新数据库的值就好，简单的增删改查。具体内容就不写了，没什么意义。"}]},{"ID":"20240922222507-a6g2nnx","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20240922222507-a6g2nnx","updated":"20240922223406"},"Children":[{"Type":"NodeText","Data":"拦截请求与检验权限"}]},{"ID":"20240922222529-aeq9kjt","Type":"NodeParagraph","Properties":{"id":"20240922222529-aeq9kjt","updated":"20240922222740"},"Children":[{"Type":"NodeText","Data":"配置MvcConfigurer，添加拦截器LoginInterceptor()。"}]},{"ID":"20240922222719-iz29mt3","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20240922222719-iz29mt3","updated":"20240922223358"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"amF2YQ=="},{"Type":"NodeCodeBlockCode","Data":"@Override\n    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {\n        if (handler instanceof HandlerMethod) {\n\n            HandlerMethod method = (HandlerMethod) handler;// 把handler强转为HandlerMethod\n            Method key = method.getMethod();\n\n            // 是否在免登录组里\n            if (checkNeedLogin(key)) {\n                return true;\n            }\n\n            Users user = checkLogin(request);\n\n            // TODO: 黑名单\n\n            if (checkIsBase(key)) {\n                return true;\n            }\n\n\n            // 查出该用户加入的非基础权限组 基础权限组 和 免登录组映射关系不在usersofGroup表中\n            UsersOfGroup usersOfGroupParams = new UsersOfGroup();\n            usersOfGroupParams.setUserId(user.getId());\n            usersOfGroupParams.setIsEffective(1);\n            List\u003cUsersOfGroup\u003e usersOfGroupRet = usersOfGroupService.queryAll(usersOfGroupParams);\n            ConcurrentHashMap\u003cLong, PermissionMappingInfo.PermissionMappingInfoEntry\u003e map = permissionMappingInfo.getMethodsPermissionGroupsOther().get(key);\n            for (UsersOfGroup ug:\n                 usersOfGroupRet) {\n                // 判断该用户加入组是否有效\n                if (ug.getIsEffective() != 1 || !checkDate(ug.getStartAt(), ug.getEndAt())) {\n                    // 一个有效即可\n                    continue;\n                }\n\n                // 是否是dev组成员\n                if (Objects.equals(ug.getGroupId(), PermissionGroupConstant.DEV_GROUP.getId())) {\n                    return true;\n                }\n\n                if (map == null || map.isEmpty()) {\n                    // 该方法没有加入到其他权限组\n                    continue;\n                }\n\n                PermissionMappingInfo.PermissionMappingInfoEntry entry = map.get(ug.getGroupId());\n                if (entry == null) {\n                    continue;\n                }\n\n                if (checkSingleGroup(entry.getPermissionGroups(), entry.getPathsOfGroup())) {\n\t\t\t\t\t//简单检测date和isEffective后\n                    return true;\n                }\n            }\n\n\n            throw new ForbiddenException();\n        }\n        throw new ForbiddenException();\n    }\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20240922222751-pxk5xee","Type":"NodeParagraph","Properties":{"id":"20240922222751-pxk5xee","updated":"20240922222919"},"Children":[{"Type":"NodeText","Data":"这样就好了，对每个请求都检测。"}]},{"ID":"20240922223406-hvzi7x3","Type":"NodeParagraph","Properties":{"id":"20240922223406-hvzi7x3","updated":"20240922223406"}}]}